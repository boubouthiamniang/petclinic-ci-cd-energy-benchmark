name: Java CI with Gradle + Eco-CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      # 1️⃣ Install minimal dependencies (like GitLab)
      - name: Install system dependencies
        run: |
          apk update
          apk add --no-cache git curl jq openjdk17 bash

      # 2️⃣ Checkout your repository (Eco-CI scripts are included in repo)
      - uses: actions/checkout@v4

      # 3️⃣ Start Eco-CI measurement
      - name: Start measurement
        run: |
          bash ./eco-ci/scripts/setup.sh start_measurement \
            "/tmp/machine_power_data.json" \
            "${{ github.run_id }}" \
            "${{ github.ref_name }}" \
            "${{ github.repository }}" \
            "${{ github.workflow }}" \
            "${{ github.sha }}" \
            "manual" \
            "true" \
            "filter_type" \
            "filter_project" \
            "filter_machine" \
            "tags" \
            "constant" \
            "0.5" \
            "API_TOKEN" \
            "GMT_API_TOKEN" \
            "true" \
            "API_ENDPOINT_ADD" \
            "API_ENDPOINT_BADGE_GET" \
            "DASHBOARD_URL" \
            "placeholder22"

      # 4️⃣ Make gradlew executable (if using Gradle wrapper)
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5️⃣ Build project
      - name: Build with Gradle
        run: ./gradlew build --exclude-task test

      # 6️⃣ End Eco-CI measurement
      - name: End measurement
        run: bash ./eco-ci/scripts/setup.sh end_measurement

      # 7️⃣ Display results
      - name: Display results
        run: bash ./eco-ci/scripts/display-results.sh --json-output > /tmp/eco-ci/total-data.json

      # 8️⃣ Upload results
      - name: Upload Eco-CI total-data.json
        uses: actions/upload-artifact@v4
        with:
          name: eco-ci-total-data
          path: /tmp/eco-ci/total-data.json
          retention-days: 30
